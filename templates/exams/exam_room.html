{% extends 'core/base.html' %}
{% load static %}

{% block title %}Exam Room - {{ exam.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="content">
        <h1 class="content-title">Exam Room: {{ exam.title }}</h1>

        <div id="exam-status" class="card">
            <h2 class="card-title">Exam Status</h2>
            {% if exam.date > now %}
                <p>The exam has not started yet. Please wait.</p>
                <p id="countdown" data-exam-date="{{ exam.date|date:'Y-m-d H:i:s' }}"></p>
            {% elif student_exam.status == 'in_progress' %}
                <p>The exam is in progress. Good luck!</p>
                <p id="timer" class="text-primary"></p>
            {% elif student_exam.status == 'completed' %}
                <p>You have completed this exam.</p>
            {% else %}
                <p>Waiting for the exam to start...</p>
            {% endif %}
        </div>

        <div id="exam-content" class="mt-20" style="display: none;">
            <!-- Exam content will be loaded here -->
        </div>

        <button id="submit-exam" class="btn btn-primary mt-20" style="display: none;">Submit Exam</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const examSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/exam/{{ exam.id }}/'
    );

    let endTime;

    examSocket.onmessage = function(e) {
        console.log('WebSocket connection established');
        const data = JSON.parse(e.data);
        if (data.type === 'exam_start') {
            startExam();
        } else if (data.type === 'exam_end') {
            endExam();
        }
    };

    // Debugging Starts

    examSocket.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
    examSocket.onclose = function() {
        console.log('WebSocket connection closed');
    };

        // Debugging Ends


    function startExam() {
        document.getElementById('exam-status').innerHTML = '<p>The exam has started. Good luck!</p><p id="timer"></p>';
        document.getElementById('exam-content').style.display = 'block';
        loadExamContent();
        startTimer();
        document.getElementById('submit-exam').style.display = 'block';
    }

    function loadExamContent() {
        fetch('/api/exam-content/{{ exam.id }}/')
            .then(response => response.json())
            .then(data => {
                const contentDiv = document.getElementById('exam-content');
                contentDiv.innerHTML = '';
                data.questions.forEach(question => {
                    const questionDiv = document.createElement('div');
                    questionDiv.innerHTML = `
                        <h3>${question.text}</h3>
                        <textarea id="answer-${question.id}" rows="4" cols="50"></textarea>
                    `;
                    contentDiv.appendChild(questionDiv);

                    const textarea = questionDiv.querySelector('textarea');
                    textarea.addEventListener('blur', () => saveAnswer(question.id, textarea.value));
                });
            });
    }

    function saveAnswer(questionId, answerText) {
        const formData = new FormData();
        formData.append('question_id', questionId);
        formData.append('answer_text', answerText);

        fetch('/api/save-answer/{{ exam.id }}/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Answer saved successfully');
            } else {
                console.error('Failed to save answer');
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


    /*
    function startTimer() {
        const startTime = new Date();
        endTime = new Date(startTime.getTime() + {{ exam.duration.total_seconds }} * 1000);
        updateTimer();
        setInterval(updateTimer, 1000);
    }
        */

    
    function startTimer() {
        const startTime = new Date();
        // Use parseInt to make sure it's treated as a number, and wrap it in quotes
        const duration = parseInt('{{ exam.duration.total_seconds|default:"0" }}', 10);
        if (!isNaN(duration)) {
            endTime = new Date(startTime.getTime() + duration * 1000);
            updateTimer();
            setInterval(updateTimer, 1000);
        } else {
            console.error('Invalid duration value:', '{{ exam.duration.total_seconds }}');
        }
    }


    function updateTimer() {
        const now = new Date().getTime();
        const timeLeft = endTime - now;

        if (timeLeft <= 0) {
            endExam();
        } else {
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById('timer').innerHTML = `Time remaining: ${hours}h ${minutes}m ${seconds}s`;
        }
    }

    function endExam() {
        document.getElementById('exam-status').innerHTML = '<p>The exam has ended. Thank you for participating.</p>';
        document.getElementById('exam-content').style.display = 'none';
        document.getElementById('submit-exam').style.display = 'none';
        examSocket.send(JSON.stringify({
            'type': 'exam_end',
            'student_id': '{{ request.user.id }}'
        }));
    }

    function updateCountdown() {
        const countdownElement = document.getElementById('countdown');
        if (countdownElement) {
            const examDate = new Date(countdownElement.dataset.examDate).getTime();
            const now = new Date().getTime();
            const distance = examDate - now;

            if (distance < 0) {
                countdownElement.innerHTML = "Exam is starting...";
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            countdownElement.innerHTML = `Time until exam starts: ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
    }

    setInterval(updateCountdown, 1000);
    updateCountdown();

    // Immediately start the exam if it's already in progress
    {% if student_exam.status == 'in_progress' %}
        startExam();
    {% endif %}

    // Handle early submission
    document.getElementById('submit-exam').addEventListener('click', function() {
        if (confirm('Are you sure you want to submit your exam? This action cannot be undone.')) {
            endExam();
        }
    });
</script>
{% endblock %}
