{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="mb-4">{{ exam.title }}</h1>
    <div id="timer" class="alert alert-info mb-4"></div>

    <form id="exam-form" method="post">
        {% csrf_token %}

        {% if mcq_questions %}
        <div class="card mb-4">
            <div class="card-header">
                <h2>Multiple Choice Questions</h2>
            </div>
            <div class="card-body">
                {% for question in mcq_questions %}
                <div class="question mb-4">
                    <h5>Question {{ forloop.counter }}</h5>
                    <p>{{ question.text }}</p>
                    <div class="options">
                        {% for option in question.options.all %}
                        <div class="form-check mb-2">
                            <input 
                                class="form-check-input" 
                                type="radio" 
                                name="mcq_{{ question.id }}" 
                                id="option_{{ option.id }}" 
                                value="{{ option.id }}"
                                required
                            >
                            <label class="form-check-label" for="option_{{ option.id }}">
                                {{ option.order }}) {{ option.text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if essay_questions %}
        <div class="card mb-4">
            <div class="card-header">
                <h2>Essay Questions</h2>
            </div>
            <div class="card-body">
                {% for question in essay_questions %}
                <div class="question mb-4">
                    <h5>Question {{ forloop.counter }}</h5>
                    <p>{{ question.text }}</p>
                    <textarea 
                        name="essay_{{ question.id }}" 
                        class="form-control" 
                        rows="6"
                        required
                    ></textarea>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <button type="submit" class="btn btn-primary btn-lg btn-block mb-4">Submit Exam</button>
    </form>
</div>

<script>
    const examSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/exam/{{ exam.id }}/'
    );

    examSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'exam_started') {
            startExam();
        } else if (data.type === 'exam_ended') {
            endExam();
        }
    };

    function startExam() {
        document.getElementById('exam-form').classList.remove('disabled');
    }

    function endExam() {
        document.getElementById('exam-form').submit();
    }

    // Countdown timer
    let timeRemaining = {{ time_remaining }};
    const timerElement = document.getElementById('timer');

    function updateTimer() {
        const hours = Math.floor(timeRemaining / 3600);
        const minutes = Math.floor((timeRemaining % 3600) / 60);
        const seconds = timeRemaining % 60;
        
        const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timerElement.textContent = `Time Remaining: ${formattedTime}`;
        
        if (timeRemaining <= 300) { // 5 minutes remaining
            timerElement.classList.remove('alert-info');
            timerElement.classList.add('alert-warning');
        }
        
        if (timeRemaining <= 60) { // 1 minute remaining
            timerElement.classList.remove('alert-warning');
            timerElement.classList.add('alert-danger');
        }
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            examSocket.send(JSON.stringify({
                'type': 'end_exam',
                'student_id': '{{ request.user.id }}'
            }));
        }
        
        timeRemaining--;
    }

    const timerInterval = setInterval(updateTimer, 1000);

    // Prevent accidental page refresh/navigation
    window.onbeforeunload = function() {
        return "Are you sure you want to leave? Your exam progress will be lost.";
    };

    // Start exam when the page loads
    window.onload = function() {
        examSocket.send(JSON.stringify({
            'type': 'start_exam',
            'student_id': '{{ request.user.id }}'
        }));
        updateTimer();
    };
</script>
{% endblock %}